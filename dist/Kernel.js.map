{"version":3,"file":"Kernel.js","sources":["../src/Kernel.js","../src/Util.js"],"sourcesContent":["import * as Util from './Util'\n\nfunction get(root, ref) {\n    if (!Util.isObject(root) || !Util.isString(ref)) return null;\n    var node = root;\n    var refs = ref.split('.');\n    while (refs.length >= 1) {\n        if (refs.length === 1) {\n            return {\n                target: node,\n                property: refs[0]\n            };\n        }\n        node = node[refs.shift()];\n        if (!Util.isObject(node)) return null;\n    }\n    return null;\n}\nfunction set(root, ref, val) {\n    var obj = get(root, ref);\n    if (obj) obj.target[obj.property] = val;\n}\n\nvar Dnstreams = {};\nvar ResultsIn = {};\nvar Upstreams = {};\nvar ResultsFrom = {};\n\n/**\n * Kernel constructor function.\n * @param {Object} root                             [description]\n * @param {String} alias                            [description]\n * @param {any} value                               [description]\n * @param {Object} relations                        [description]\n * @constructor\n */\nfunction Kernel(root, alias, value, relations) {\n    var obj = get(root, alias);\n    if (obj == null) return;\n    Object.defineProperty(this, '__alias', {\n        value: alias\n    });\n    var v = value;\n    var dnstream = relations.dnstream;\n    var resultIn = relations.resultIn;\n    var upstream = relations.upstream;\n    var resultFrom = relations.resultFrom;\n    if (Util.isString(dnstream)) dnstream = [dnstream];\n    if (Util.isArray(dnstream)) {\n        dnstream.forEach(function (a) {\n            Upstreams[a][alias] = true;\n            Dnstreams[alias][a] = true;\n        });\n    } else {\n        dnstream = [];\n    }\n    if (Util.isFunction(resultIn)) {\n        ResultsIn[alias] = resultIn;\n    }\n    if (Util.isString(upstream)) upstream = [upstream];\n    if (Util.isArray(upstream)) {\n        upstream.forEach(function (a) {\n            Upstreams[alias][a] = true;\n            Dnstreams[a][alias] = true;\n        });\n    } else {\n        upstream = [];\n    }\n    if (Util.isFunction(resultFrom)) {\n        ResultsFrom[alias] = resultFrom;\n    }\n    Object.defineProperty(obj.target, obj.property, {\n        get: function () {\n            if (!ResultsFrom[alias]) return v;\n            return ResultsFrom[alias].apply(root, upstream.map(function (a) { return get(root, a) }));\n        },\n        set: function (_v) {\n            if (_v === v) return;\n            v = _v;\n            ResultsIn[alias] && ResultsIn[alias].apply(root, [_v]);\n            dnstream.forEach(function (a) {\n                if (ResultsFrom[a]) set(root, a, get(root, a));\n            });\n        },\n        enumerable: true\n    });\n}\n\nKernel.prototype.disable = function () {};\nKernel.prototype.enable = function () {};\nKernel.prototype.destroy = function () {};\n\nexport default Kernel\n","var gid = (function () {\n    var n = 0;\n    return function () {\n        return n++;\n    };\n})();\n\nvar isBoolean = function (v) {\n    return typeof v === 'boolean';\n};\n\nvar isNumber = function (v) {\n    return typeof v === 'number';\n};\n\nvar isNumeric = function (v) {\n    var n = parseInt(v);\n    if (isNaN(n)) return false;\n    return (typeof v === 'number' || typeof v === 'string') && n == v;\n};\n\nvar isString = function (v) {\n    return typeof v === 'string';\n};\n\nvar isFunction = function (v) {\n    return typeof v === 'function';\n};\n\nvar isObject = function (v) {\n    return Object.prototype.toString.call(v) === '[object Object]';\n};\n\nvar isArray = function (v) {\n    return Object.prototype.toString.call(v) === '[object Array]';\n};\n\nvar isBasic = function (v) {\n    return v == null\n        || typeof v === 'boolean'\n        || typeof v === 'number'\n        || typeof v === 'string'\n        || typeof v === 'function';\n};\n\nvar isInstance = function (v, creator) {\n    return typeof creator === 'function' && v instanceof creator;\n};\n\nvar isDirectInstance = function (v, creator) {\n    return v.constructor === creator;\n};\n\nvar isNode = function (v) {\n    return v instanceof Node;\n};\n\nvar isNamedNodeMap = function (v) {\n    return v instanceof NamedNodeMap;\n};\n\nvar isEventName = function (v) {\n    if (!isString(v)) return false;\n    return v.startsWith('on'); // TODO\n};\n\nvar isCSSSelector = function (v) {\n    return v.indexOf(' ') > 0 || v.indexOf('.') >= 0\n        || v.indexOf('[') >= 0 || v.indexOf('#') >= 0;\n};\n\nvar each = function (v, func, arrayReverse) {\n    if (isObject(v)) {\n        for (var p in v) {\n            if (!v.hasOwnProperty(p)) continue;\n            var r = func(v[p], p);\n            if (r === false) break;\n        }\n    } else if (isArray(v)) {\n        if (!arrayReverse) {\n            for (var i = 0, len = v.length; i < len; i++) {\n                var r = func(v[i], i);\n                if (r === false) break;\n            }\n        } else {\n            for (var i = v.length - 1; i >= 0; i--) {\n                var r = func(v[i], i);\n                if (r === false) break;\n            }\n        }\n    } else if (isNode(v)) {\n        var ret = false;\n        switch (v.nodeType) {\n            case Node.ELEMENT_NODE:\n                break;\n            case Node.TEXT_NODE:\n            case Node.COMMENT_NODE:\n            case Node.PROCESSING_INSTRUCTION_NODE:\n            case Node.DOCUMENT_NODE:\n            case Node.DOCUMENT_TYPE_NODE:\n            case Node.DOCUMENT_FRAGMENT_NODE:\n            default:\n                ret = true;\n        }\n        if (ret) return;\n        for (var i = 0, childNodes = v.childNodes, len = v.childNodes.length; i < len; i++) {\n            func(childNodes[i]);\n            each(childNodes[i], func);\n        }\n    } else if (isNamedNodeMap(v)) {\n        for (var i = 0, len = v.length; i < len; i++) {\n            var r = func(v[i]['nodeValue'], v[i]['nodeName']);\n            if (r === false) break;\n        }\n    } else if (Util.isFunction(v.forEach)) {\n        v.forEach(func);\n    }\n};\n\nvar eachUnique = function (arr, func) {\n    if (!isArray(arr)) return;\n    var map = {};\n    for (var i = 0, len = arr.length; i < len; i++) {\n        if (!isNumber(arr[i]) || !isString(arr[i]) || map[arr[i]]) continue;\n        map[arr[i]] = true;\n        var r = func(arr[i]);\n        if (r === false) break;\n    }\n};\n\nvar unique = function (arr) {\n    var r = [];\n    eachUnique(arr, function (v) {\n        r.push(v);\n    });\n    return r;\n};\n\nvar clone = function (val) {\n    var r = val;\n    if (isObject(val)) {\n        r = {};\n        each(val, function (v, p) {\n            r[p] = clone(v);\n        });\n    } else if (isArray(val)) {\n        r = [];\n        each(val, function (v) {\n            r.push(clone(v));\n        });\n    }\n    return r;\n};\n\nvar hasProperty = function (val, p) {\n    if (isObject(val)) {\n        return val.hasOwnProperty(p);\n    } else if (isArray(val)) {\n        var n = parseInt(p);\n        return isNumeric(p) && val.length > n && n >= 0;\n    }\n    return false;\n};\n\nvar clear = function (val, p, withBasicVal) {\n    var inRef = isString(p) || isNumber(p);\n    var target = inRef ? val[p] : val;\n\n    if (isObject(target) || isArray(target)) {\n        each(target, function (v, p) {\n            clear(target, p);\n        });\n        if (isArray(target)) {\n            shrinkArray(target);\n        }\n    }\n\n    if (inRef) {\n        val[p] = withBasicVal;\n    }\n};\n\nvar shrinkArray = function (arr, len) {\n    var limited = isNumber(len);\n    if (!limited) {\n        each(arr, function (v, i) {\n            if (v === undefined) arr.length--;\n        }, true);\n    } else {\n        each(arr, function (v, i) {\n            if (i >= len) arr.length--;\n            else return false;\n        }, true);\n        while (arr.length < len) {\n            arr.push(null);\n        }\n    }\n    return arr;\n};\n\nvar touchLeaves = function (obj) {\n    each(obj, function (v, p) {\n        if (isBasic(v)) {\n            obj[p] = v;\n        } else {\n            touchLeaves(v);\n        }\n    });\n};\n\nvar extend = function (dest, srcs, clean) {\n    if (!isObject(dest)) return null;\n    var args = Array.prototype.slice.call(arguments, 1,\n        arguments[arguments.length - 1] === true ? (arguments.length - 1) : arguments.length);\n\n    function extendObj(obj, src, clean) {\n        if (!isObject(src)) return;\n        each(src, function (v, p) {\n            if (!hasProperty(obj, p) || isBasic(v)) {\n                if (obj[p] !== v) {\n                    obj[p] = clone(v);\n                }\n            } else {\n                extendObj(obj[p], v, clean);\n            }\n        });\n        if (clean) {\n            each(obj, function (v, p) {\n                if (!hasProperty(src, p)) {\n                    clear(obj, p);\n                }\n            });\n            if (isArray(obj)) {\n                shrinkArray(obj);\n            }\n        }\n    }\n\n    each(args, function (src) {\n        extendObj(dest, src, clean);\n    });\n    return dest;\n};\n\nexport {\n    gid,\n    isBoolean,\n    isNumber,\n    isNumeric,\n    isString,\n    isFunction,\n    isObject,\n    isArray,\n    isBasic,\n    isInstance,\n    isDirectInstance,\n    isNode,\n    isNamedNodeMap,\n    isEventName,\n    isCSSSelector,\n    each,\n    eachUnique,\n    unique,\n    clone,\n    hasProperty,\n    clear,\n    shrinkArray,\n    touchLeaves,\n    extend\n}\n"],"names":["get","root","ref","Util.isObject","Util.isString","node","refs","split","length","target","property","shift","set","val","obj","Kernel","alias","value","relations","Object","defineProperty","this","v","dnstream","resultIn","upstream","resultFrom","Util.isArray","forEach","a","Upstreams","Dnstreams","Util.isFunction","ResultsIn","ResultsFrom","apply","map","_v","enumerable","isString","isFunction","isObject","prototype","toString","call","isArray","disable","enable","destroy"],"mappings":"kLAEA,SAASA,EAAIC,EAAMC,GACf,IAAKC,EAAcF,KAAUG,EAAcF,GAAM,OAAO,KAGxD,IAFA,IAAIG,EAAOJ,EACPK,EAAOJ,EAAIK,MAAM,KACdD,EAAKE,QAAU,GAAG,CACrB,GAAoB,IAAhBF,EAAKE,OACL,OACIC,OAAQJ,EACRK,SAAUJ,EAAK,IAIvB,GADAD,EAAOA,EAAKC,EAAKK,UACZR,EAAcE,GAAO,OAAO,KAErC,OAAO,KAEX,SAASO,EAAIX,EAAMC,EAAKW,GACpB,IAAIC,EAAMd,EAAIC,EAAMC,GAChBY,IAAKA,EAAIL,OAAOK,EAAIJ,UAAYG,GAgBxC,SAASE,EAAOd,EAAMe,EAAOC,EAAOC,GAChC,IAAIJ,EAAMd,EAAIC,EAAMe,GACpB,GAAW,MAAPF,EAAJ,CACAK,OAAOC,eAAeC,KAAM,WACxBJ,MAAOD,IAEX,IAAIM,EAAIL,EACJM,EAAWL,EAAUK,SACrBC,EAAWN,EAAUM,SACrBC,EAAWP,EAAUO,SACrBC,EAAaR,EAAUQ,WACvBtB,EAAcmB,KAAWA,GAAYA,IACrCI,EAAaJ,GACbA,EAASK,QAAQ,SAAUC,GACvBC,EAAUD,GAAGb,IAAS,EACtBe,EAAUf,GAAOa,IAAK,IAG1BN,KAEAS,EAAgBR,KAChBS,EAAUjB,GAASQ,GAEnBpB,EAAcqB,KAAWA,GAAYA,IACrCE,EAAaF,GACbA,EAASG,QAAQ,SAAUC,GACvBC,EAAUd,GAAOa,IAAK,EACtBE,EAAUF,GAAGb,IAAS,IAG1BS,KAEAO,EAAgBN,KAChBQ,EAAYlB,GAASU,GAEzBP,OAAOC,eAAeN,EAAIL,OAAQK,EAAIJ,UAClCV,IAAK,WACD,OAAKkC,EAAYlB,GACVkB,EAAYlB,GAAOmB,MAAMlC,EAAMwB,EAASW,IAAI,SAAUP,GAAK,OAAO7B,EAAIC,EAAM4B,MADnDP,GAGpCV,IAAK,SAAUyB,GACPA,IAAOf,IACXA,EAAIe,EACJJ,EAAUjB,IAAUiB,EAAUjB,GAAOmB,MAAMlC,GAAOoC,IAClDd,EAASK,QAAQ,SAAUC,GACnBK,EAAYL,IAAIjB,EAAIX,EAAM4B,EAAG7B,EAAIC,EAAM4B,QAGnDS,YAAY,KC/DpB,IAAIC,EAAW,SAAUjB,GACrB,MAAoB,iBAANA,GAGdkB,EAAa,SAAUlB,GACvB,MAAoB,mBAANA,GAGdmB,EAAW,SAAUnB,GACrB,MAA6C,oBAAtCH,OAAOuB,UAAUC,SAASC,KAAKtB,IAGtCuB,EAAU,SAAUvB,GACpB,MAA6C,mBAAtCH,OAAOuB,UAAUC,SAASC,KAAKtB,IDXtCS,KACAE,KACAH,KACAI,YA8DJnB,EAAO2B,UAAUI,QAAU,aAC3B/B,EAAO2B,UAAUK,OAAS,aAC1BhC,EAAO2B,UAAUM,QAAU"}